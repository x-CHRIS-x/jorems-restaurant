{% extends "navbar.html" %}

{% block title %}Panel Dashboard - Jorem's Restaurant{% endblock %}

{% block additional_styles %}
<style>
    .dashboard-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }

    .stat-card h3 {
        margin: 0;
        color: #666;
        font-size: 0.9em;
        text-transform: uppercase;
    }

    .stat-card .value {
        font-size: 2em;
        font-weight: bold;
        color: #f39c12;
        margin: 10px 0;
    }

    .charts-row {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart-container {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        flex: 1;
        max-height: 400px;
    }

    .table-container {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }

    th {
        background: #f8f9fa;
        font-weight: 600;
    }

    .btn-print {
        background: #f39c12;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
    }

    .btn-print:hover {
        background: #e67e22;
    }

    .report-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .filter-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .filter-controls select, .filter-controls input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="report-header">
        <h1>Sales Dashboard</h1>
        <button class="btn-print" onclick="generatePDF()">Download Report</button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Today's Sales</h3>
            <div class="value">₱{{ "{:,.2f}".format(daily_sales) }}</div>
        </div>
        <div class="stat-card">
            <h3>Today's Orders</h3>
            <div class="value">{{ daily_orders }}</div>
        </div>
        <div class="stat-card">
            <h3>Monthly Sales</h3>
            <div class="value">₱{{ "{:,.2f}".format(monthly_sales) }}</div>
        </div>
        <div class="stat-card">
            <h3>Average Order Value</h3>
            <div class="value">₱{{ "{:,.2f}".format(avg_order_value) }}</div>
        </div>
    </div>

    <div class="filter-controls">
        <input type="date" id="dateFilter" onchange="updateCharts()" value="{{ today }}">
    </div>

    <div class="charts-row">
        <div class="chart-container">
            <h3 style="text-align: center; margin-bottom: 15px;">Today's Sales by Hour</h3>
            <canvas id="dailyChart"></canvas>
        </div>
        <div class="chart-container">
            <h3 style="text-align: center; margin-bottom: 15px;">Monthly Sales by Day</h3>
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>

    <div class="table-container">
        <h2>Recent Orders</h2>
        <table>
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Date</th>
                    <th>Customer ID</th>
                    <th>Total</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for order in recent_orders %}
                <tr>
                    <td>#{{ order.id }}</td>
                    <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>#{{ order.user_id }}</td>
                    <td>₱{{ "{:,.2f}".format(order.total) }}</td>
                    <td>{{ order.status }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>

    <script>
        // Make jsPDF available globally
        window.jsPDF = window.jspdf.jsPDF;
        
        // Initialize both charts
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');

        // Chart configuration options
        const chartOptions = {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₱' + value.toLocaleString();
                        }
                    }
                }
            },
            maintainAspectRatio: false
        };

        // Initialize daily chart
        const dailyChart = new Chart(dailyCtx, {
            type: 'bar',
            data: {
                labels: {{ chart_labels | tojson }},
                datasets: [{
                    label: 'Sales by Hour',
                    data: {{ chart_data | tojson }},
                    backgroundColor: '#f39c12',
                    borderColor: '#e67e22',
                    borderWidth: 1
                }]
            },
            options: chartOptions
        });

        // Initialize monthly chart with empty data
        const monthlyChart = new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Sales by Day',
                    data: [],
                    backgroundColor: '#2ecc71',
                    borderColor: '#27ae60',
                    borderWidth: 1
                }]
            },
            options: chartOptions
        });

        // Initial load of monthly data
        fetch(`/panel/chart-data?range=monthly&date=${document.getElementById('dateFilter').value}`)
            .then(response => response.json())
            .then(data => {
                monthlyChart.data.labels = data.labels;
                monthlyChart.data.datasets[0].data = data.values;
                monthlyChart.update();
            });

        function updateCharts() {
            const date = document.getElementById('dateFilter').value;
            
            // Update daily chart
            fetch(`/panel/chart-data?range=daily&date=${date}`)
                .then(response => response.json())
                .then(data => {
                    dailyChart.data.labels = data.labels;
                    dailyChart.data.datasets[0].data = data.values;
                    dailyChart.update();
                });

            // Update monthly chart
            fetch(`/panel/chart-data?range=monthly&date=${date}`)
                .then(response => response.json())
                .then(data => {
                    monthlyChart.data.labels = data.labels;
                    monthlyChart.data.datasets[0].data = data.values;
                    monthlyChart.update();
                });
        }

        function formatCurrency(value) {
            return value.replace(/₱/g, 'P');
        }

        async function generatePDF() {
            // Create new PDF document
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Add header
            doc.setFontSize(20);
            doc.text("JM Restaurant - Sales Report", 20, 20);
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 20, 30);
            
            // Add stats from cards
            doc.setFontSize(12);
            let yPos = 50;

            // Get values from the HTML, cleaning up the peso sign
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach(card => {
                const label = card.querySelector('h3').textContent;
                const rawValue = card.querySelector('.value').textContent;
                const value = formatCurrency(rawValue);
                doc.text(`${label}: ${value}`, 20, yPos);
                yPos += 10;
            });
            
            // Add daily chart
            doc.text("Daily Sales Chart", 20, 95);
            const dailyChartImage = dailyChart.canvas.toDataURL('image/png', 1.0);
            doc.addImage(dailyChartImage, 'PNG', 20, 100, 170, 70);
            
            // Add monthly chart on new page
            doc.addPage();
            doc.setFontSize(16);
            doc.text("Monthly Sales Chart", 20, 20);
            const monthlyChartImage = monthlyChart.canvas.toDataURL('image/png', 1.0);
            doc.addImage(monthlyChartImage, 'PNG', 20, 25, 170, 70);
            
            // Add recent orders table
            doc.addPage();
            doc.text("Recent Orders", 20, 20);
            
            // Draw table headers
            const startX = 20;
            let startY = 30;
            const rowHeight = 10;
            const colWidth = 40;
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            
            // Table headers
            doc.text("Order ID", startX, startY);
            doc.text("Date", startX + colWidth, startY);
            doc.text("Total", startX + (colWidth * 2), startY);
            doc.text("Status", startX + (colWidth * 3), startY);
            
            // Table rows
            doc.setFont('helvetica', 'normal');
            startY += rowHeight;
            
            // Get recent orders from the table in the HTML
            const orderRows = document.querySelectorAll('table tbody tr');
            orderRows.forEach((row, index) => {
                if (index < 10) { // Limit to 10 rows
                    const cells = row.querySelectorAll('td');
                    doc.text(cells[0].textContent, startX, startY);
                    doc.text(cells[1].textContent, startX + colWidth, startY);
                    doc.text(cells[3].textContent, startX + (colWidth * 2), startY);
                    doc.text(cells[4].textContent, startX + (colWidth * 3), startY);
                    startY += rowHeight;
                }
            });
            
            // Save the PDF
            doc.save('JM-Restaurant-Sales-Report.pdf');
        }
    </script>
{% endblock %}